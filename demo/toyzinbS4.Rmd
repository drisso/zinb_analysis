---
title: "Test Zinb (new S4 version)"
author: "Jean-Philippe Vert"
date: "September 13, 2016"
output: html_document
---

Here we demonstrate the use of the new version of ZINB, based on S4 classes, on a toy dataset. 

# Generate data
```{r}
n <- 50 # cells
J <- 100 # genes
X <- cbind(rep(1,n),c(rep(1,n/2),rep(0,n/2)))
V <- matrix(rep(1,J),ncol=1)
cluster <- X[,2]+1
beta.mu <- matrix(rnorm(2*J),nrow=2)
beta.mu[1,] <- beta.mu[1,]+4
beta.pi <- -beta.mu
gamma.mu <- matrix(rnorm(n)+3,nrow=1)
gamma.pi <- -gamma.mu
m <- zinbModel(X=X,V=V)
m@beta_mu <- beta.mu
m@beta_pi <- beta.pi
m@gamma_mu <- gamma.mu
m@gamma_pi <- gamma.pi
a <- zinbSim(m)
Y <- a$counts
plot(apply(Y,1,sum),xlab="Cell",ylab="Total count")
```
# Standard PCA

Let us first look at the toy data using standard PCA of the log(count+1) matrix

```{r message=FALSE}
pc <- prcomp(log(1+Y),center=TRUE,scale.=TRUE)
plot(pc$x[,1:2],main="PCA on log(count+1)",col=cluster,lwd=2)
plot(gamma.mu[1,],pc$x[,1],xlab="Coverage",ylab="PC1",col=cluster,lwd=2)
plot(gamma.mu[1,],pc$x[,2],xlab="Coverage",ylab="PC2",col=cluster,lwd=2)
```

We see two well-separated clusters, mostly separated along the first principal component.

# ZINB
Let us fit a ZINB model, with `{r}K=2` latent factors, and correction of cell- and gene-specific intercepts
```{r message=FALSE}
m.zinb <- zinbFit(Y,K=2,ncores=7,verbose=TRUE)
plot(m.zinb@W[,1],m.zinb@W[,2],xlab="PC1",ylab="PC2",main="ZINB",col=cluster,lwd=2)
plot(m@beta_mu[1,])
plot(m@gamma_mu[1,],col=cluster,lwd=2)
```

Let's look at correlation with coverage
```{r}
cover <- apply(toydata, 1, sum)
cor(cbind(cover,pc$x[,1:2]))
cor(cbind(cover,m@W))
```

# Fluidigm
Attach package scRNAseq, select high quality cells, filter out those which do not have at least 10 counts in at least 10 cells and run zinb
```{r, eval=TRUE}
library(SummarizedExperiment)
library(scRNAseq)
data("fluidigm")
high.cov.cells=assays(fluidigm)$counts[,which(colData(fluidigm)$Coverage_Type=="High")]
filter.out=apply(high.cov.cells>10,1,sum)<10
```
Number of genes which remain:
```{r}
print(sum(!filter.out)) 
```

Select those genes and run zinb PCA:

```{r}
fluidigm2=t(high.cov.cells[!filter.out,])
pc.fluidigm <- prcomp(log(1+fluidigm2),center=TRUE,scale.=TRUE)
plot(pc.fluidigm$x[,1:2],col=colData(fluidigm)$Cluster2[colData(fluidigm)$Coverage_Type=="High"])
```

Correlation with coverage
```{r}
cover <- apply(fluidigm2,1,sum)
plot(cover,pc.fluidigm$x[,1],xlab="Coverage",ylab="PC1")
plot(cover,pc.fluidigm$x[,2],xlab="Coverage",ylab="PC2")
```

ZINB model
```{r}
zinb.fluidigm <- zinbFit(fluidigm2,K=2,ncores=7,verbose=TRUE)
```

Plot the results with cells colored according to their cluster

```{r, echo=FALSE}
plot(zinb.fluidigm@W[,1:2],col=colData(fluidigm)$Cluster2[colData(fluidigm)$Coverage_Type=="High"])
```

Correlation with coverage
```{r, echo=FALSE}
plot(cover,zinb.fluidigm@gamma_mu[1,])
plot(cover,zinb.fluidigm@W[,1])
plot(cover,zinb.fluidigm@W[,2])
cor(cbind(cover,pc.fluidigm$x[,1:2]))
cor(cbind(cover,zinb.fluidigm@W[,1:2]))
```

# Fluidigm with variable dispersion
```{r}
zinb.fluidigm2 <- zinbFit(fluidigm2,K=2,ncores=7,verbose=TRUE,commondispersion=FALSE)
plot(zinb.fluidigm2@W[,1:2],col=colData(fluidigm)$Cluster2[colData(fluidigm)$Coverage_Type=="High"])

```
