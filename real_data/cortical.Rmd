---
title: "Analysis of the cortical data"
author: "Davide Risso"
date: "10/19/2016"
output: 
  html_document: 
    fig_height: 7
    fig_width: 7
    toc: yes
    code_folding: hide
    toc_float: yes
---

```{r options, echo=FALSE, results="hide",mesasge=FALSE, error=FALSE, include=FALSE, autodep=TRUE}
knitr::opts_chunk$set(fig.align="center", cache=TRUE, error=FALSE, message=FALSE, warning=TRUE)
library(SummarizedExperiment)
library(scRNAseq)
library(zinb)
library(ggplot2)
library(magrittr)
library(matrixStats)
library(brainData)
library(Rtsne)

set.seed(20)
```

## TL;DR

Applying our zero-inflated model to the cortical data (L5 only).

## Unnormalized data

We select only the cells that pass QC and that were clustered (no -1 labels), color coded by the cluster labels. I will focus on the top 1,000 most variable genes. Note that the data are not public, hence it will work only on Davide's system (for now).

```{r datain}
data("cortical")
labels <- read.table("~/git/brainData/analysis/results_160705/cluster_labels.txt", stringsAsFactors = FALSE, sep='\t', comment.char = "%")

l5_data <- cortical[, rownames(labels[labels$ClusterMergedLabel!="-1",])]

filter <- apply(assay(l5_data)>10, 1, sum)>=10
```

Number of retained genes:
```{r}
print(sum(filter))
```

To speed up the computations, I will focus on the top 1,000 most variable genes.

```{r filtering}
l5_data <- l5_data[filter,]
core <- assay(l5_data)

vars <- rowVars(log1p(core))
names(vars) <- rownames(core)
vars <- sort(vars, decreasing = TRUE)
core <- core[names(vars)[1:1000],]
```

First, let's look at PCA (of the log counts) for reference.

```{r pca}
colMerged <- labels[labels$ClusterMergedLabel!="-1", "ClusterMergedColor"]

detection_rate <- colSums(core>0)
coverage <- colSums(core)

pca <- prcomp(t(log1p(core)))
plot(pca$x, col=colMerged, pch=19, main="PCA of log-counts, centered not scaled")
```

```{r pca_cor}
df <- data.frame(PC1=pca$x[,1], PC2=pca$x[,2], detection_rate=detection_rate, coverage=coverage)
pairs(df, pch=19, col=colMerged)

print(cor(df, method="spearman"))
```

Now, let's see how ZINB works.

```{r zinb}
print(system.time(zinb_Vall <- zinbFit(core, ncores = 3, K = 2)))
```

```{r zinb_plot}
plot(zinb_Vall@W, col=colMerged, pch=19, xlab="W1", ylab="W2", main="ZINB")
```

```{r gamma}
#total number of detected genes in the cell
df <- data.frame(W1=zinb_Vall@W[,1], W2=zinb_Vall@W[,2], gamma_mu = zinb_Vall@gamma_mu[1,], gamma_pi = zinb_Vall@gamma_pi[1,], detection_rate=detection_rate, coverage=coverage)
pairs(df, pch=19, col=colMerged)

print(cor(df, method="spearman"))
```

## Accounting for batch effects

```{r batch_explore}
batch <- droplevels(colData(l5_data)$MD_c1_run_id)
mod <- model.matrix(~batch)

boxplot(df$W1~batch)
boxplot(df$W2~batch)

```

```{r zinb_batch}
print(system.time(zinb_X <- zinbFit(core, ncores = 3, K = 2, X=mod)))
```

```{r batch_plot}
plot(zinb_X@W, col=colMerged, pch=19, xlab="W1", ylab="W2", main="ZINB")
```

```{r batch_gamma}
#total number of detected genes in the cell
df <- data.frame(W1=zinb_X@W[,1], W2=zinb_X@W[,2], gamma_mu = zinb_X@gamma_mu[1,], gamma_pi = zinb_X@gamma_pi[1,], detection_rate=detection_rate, coverage=coverage)
pairs(df, pch=19, col=colMerged)

print(cor(df, method="spearman"))

boxplot(df$W1~batch)
boxplot(df$W2~batch)
```

## Accounting for quality

```{r qpca}
qc <- as.matrix(colData(l5_data)[,1:14])
qcpca <- prcomp(qc, center=TRUE, scale.=TRUE)
mod <- model.matrix(~batch + qcpca$x[,1:2])

plot(df$W1~qcpca$x[,1], pch=19, col=colMerged)
plot(df$W2~qcpca$x[,1], pch=19, col=colMerged)
```

```{r zinb_qpca}
print(system.time(zinb_q <- zinbFit(core, ncores = 3, K = 2, X=mod)))
```

```{r qpca_plot}
plot(zinb_q@W, col=colMerged, pch=19, xlab="W1", ylab="W2", main="ZINB")
```

```{r qpca_gamma}
#total number of detected genes in the cell
df <- data.frame(W1=zinb_q@W[,1], W2=zinb_q@W[,2], gamma_mu = zinb_q@gamma_mu[1,], gamma_pi = zinb_q@gamma_pi[1,], detection_rate=detection_rate, coverage=coverage)
pairs(df, pch=19, col=colMerged)

print(cor(df, method="spearman"))

boxplot(df$W1~batch)
boxplot(df$W2~batch)
```

## Three dimensions

```{r zinb_three}
print(system.time(zinb_3 <- zinbFit(core, ncores = 3, K = 3, X=mod)))
```

```{r three_plot}
pairs(zinb_3@W, col=colMerged, pch=19, main="ZINB")
```

```{r three_gamma}
#total number of detected genes in the cell
df <- data.frame(W1=zinb_3@W[,1], W2=zinb_3@W[,2], W3=zinb_3@W[,3], gamma_mu = zinb_3@gamma_mu[1,], gamma_pi = zinb_3@gamma_pi[1,], detection_rate=detection_rate, coverage=coverage)
pairs(df, pch=19, col=colMerged)

print(cor(df, method="spearman"))
```

## Removing glia

```{r noglia}
noglia_data <- cortical[,rownames(labels[!(labels$ClusterMergedLabel %in% c("-1", "m4", "m5")),])]
filter <- apply(assay(noglia_data)>10, 1, sum)>=10

noglia <- assay(noglia_data[filter,])
colNoglia <- labels[!(labels$ClusterMergedLabel %in% c("-1", "m4", "m5")), "ClusterMergedColor"]

vars <- rowVars(log1p(noglia))
names(vars) <- rownames(noglia)
vars <- sort(vars, decreasing = TRUE)
noglia <- noglia[names(vars)[1:1000],]

batch <- droplevels(colData(noglia_data)$MD_c1_run_id)
qc <- as.matrix(colData(noglia_data)[,1:14])
qcpca <- prcomp(qc, center=TRUE, scale.=TRUE)
mod <- model.matrix(~batch + qcpca$x[,1:2])
```

```{r zinb_noglia}
print(system.time(zinb_noglia <- zinbFit(noglia, ncores = 3, K = 3, X=mod)))
```

```{r noglia_plot}
pairs(zinb_noglia@W, col=colNoglia, pch=19, main="ZINB")
```

## Removing "Pink cells"

```{r nopink}
nopink_data <- cortical[,rownames(labels[!(labels$ClusterMergedLabel %in% c("-1", "m2", "m4", "m5", "m6")),])]
filter <- apply(assay(nopink_data)>10, 1, sum)>=10

nopink <- assay(nopink_data[filter,])
colNopink <- labels[!(labels$ClusterMergedLabel %in% c("-1", "m2", "m4", "m5", "m6")), "ClusterMergedColor"]

vars <- rowVars(log1p(nopink))
names(vars) <- rownames(nopink)
vars <- sort(vars, decreasing = TRUE)
nopink <- nopink[names(vars)[1:1000],]

batch <- droplevels(colData(nopink_data)$MD_c1_run_id)
qc <- as.matrix(colData(nopink_data)[,1:14])
qcpca <- prcomp(qc, center=TRUE, scale.=TRUE)
mod <- model.matrix(~batch + qcpca$x[,1:2])
```

```{r zinb_nopink}
print(system.time(zinb_nopink <- zinbFit(nopink, ncores = 3, K = 3, X=mod)))
```

```{r nopink_plot}
pairs(zinb_nopink@W, col=colNopink, pch=19, main="ZINB")
```

## Using all genes

```{r zinb_all}
core <- assay(l5_data)
batch <- droplevels(colData(l5_data)$MD_c1_run_id)
qc <- as.matrix(colData(l5_data)[,1:14])
qcpca <- prcomp(qc, center=TRUE, scale.=TRUE)
mod <- model.matrix(~batch + qcpca$x[,1:2])

print(system.time(zinb_all <- zinbFit(core, ncores = 3, K = 3, X=mod)))
```

```{r all_plot}
pairs(zinb_all@W, col=colMerged, pch=19, main="ZINB")
```
