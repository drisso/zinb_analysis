---
title: "4k + 8k PBMCs"
author: "Davide Risso"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document: 
    fig_height: 7
    fig_width: 7
    toc: yes
    code_folding: hide
    toc_float: yes
---

```{r options, echo=FALSE, results="hide",mesasge=FALSE, error=FALSE, include=FALSE, autodep=TRUE}
knitr::opts_chunk$set(fig.align="center", cache=TRUE, error=FALSE, message=FALSE, warning=FALSE)
library(zinbwave)
library(ggplot2)
library(magrittr)
library(matrixStats)
library(Rtsne)
library(RColorBrewer)
library(cowplot)

set.seed(8283)
ncores <- 6
```

# Read and combine data

Here we use the frozen PBMC data from the 10x genomics paper. They are supposed 
to be from two different donors, so we should see some batch effects that hopefully
ZINB-WaVE will be able to remove.

```{r datain}
library(cellrangerRkit)
pipestance_path <- "tenx_frozen1"
if(!file.exists(paste0(pipestance_path, "/outs"))) {
  download_sample(sample_name="frozen_pbmc_donor_b",sample_dir=pipestance_path,
                  host="http://cf.10xgenomics.com/samples/cell-exp/1.1.0/")
}
pbmc_b <- load_cellranger_matrix(pipestance_path)
dim(pbmc_b)

pipestance_path <- "tenx_frozen2"
if(!file.exists(paste0(pipestance_path, "/outs"))) {
  download_sample(sample_name="frozen_pbmc_donor_c",sample_dir=pipestance_path,
                  host="http://cf.10xgenomics.com/samples/cell-exp/1.1.0/")
}
pbmc_c <- load_cellranger_matrix(pipestance_path)
dim(pbmc_c)

batch <- as.factor(paste0("batch", c(rep(1, NCOL(pbmc_b)), rep(2, NCOL(pbmc_c)))))
table(batch)

stopifnot(all(rownames(pbmc_b) == rownames(pbmc_c)))
combined <- cbind(exprs(pbmc_b), exprs(pbmc_c))
dim(combined)
```

```{r filter}
pal <- clusterExperiment::bigPalette

filter <- rowSums(combined>0)>=100
table(filter)
filtered <- combined[filter,]
```

# PCA

```{r pca}
library(rARPACK)
fastpca <- function(expr, scale=FALSE) {
  k <- 50
  svd_raw <- svds(scale(t(expr), center=TRUE, scale=scale), k=k, nu=k, nv=0)
  pc_raw <- svd_raw$u %*% diag(svd_raw$d[1:k])
  return(pc_raw)
}

norm10x = function (ei)
{
  sums = colSums(ei)
  eo = t(t(ei)*median(sums)/sums)
  return(eo)
}

tc <- norm10x(filtered)

dense <- as.matrix(filtered)
library(pryr)
object_size(dense)
object_size(filtered)

vars <- rowVars(log(dense+.1))
names(vars) <- rownames(dense)
vars <- sort(vars, decreasing = TRUE)
vargenes <- names(vars)[1:1000]

dense <- dense[vargenes,]

pc_tc <- fastpca(log(tc[rownames(dense),]+.1))

pairs(pc_tc[,1:5], pch=19, col=pal[batch])
```

PCA shows pretty strong cell-type clusters, even though the cells are derived from two
different donors. However, PC5 shows some clear batch effects.

# t-SNE

```{r tsne}
library(Rtsne)
tsne_data <- Rtsne(pc_tc[,1:50], pca=FALSE)

plot(tsne_data$Y, pch=19, col=pal[batch], xlab="TSNE 1", ylab="TSNE 2", main="t-SNE (PCA)")
legend("topleft", levels(batch), fill=pal)
```

When displaying the data with t-SNE based on the top 50 PCs, batch effects are
pretty obvious.

# ZINB-WaVE

```{r zinb}
library(BiocParallel)
library(doParallel)
registerDoParallel(ncores)
register(DoparParam())
Xmod <- model.matrix(~batch)
system.time(zinb_res <- zinbFit(dense, K=10, X = Xmod))
```

```{r plot_zinb}
W <- getW(zinb_res)
plot(W, pch=19, col=pal[batch])
pairs(W[,1:5], pch=19, col=pal[batch])
```

```{r tsne_zinb}
tsne_zinb <- Rtsne(W, pca=FALSE)

plot(tsne_zinb$Y, pch=19, col=pal[batch], xlab="TSNE 1", ylab="TSNE 2", main="t-SNE (ZINB-WaVE)")
```

# Clustering

```{r seurat2, eval=FALSE}
library(Seurat)
library(dplyr)
library(Matrix)

pbmc.data <- Read10X("tenx_frozen1/outs/filtered_gene_bc_matrices/hg19/")
pbmc.data2 <- Read10X("tenx_frozen2/outs/filtered_gene_bc_matrices/hg19/")
pbmc.comb <- cbind(pbmc.data, pbmc.data2)
pbmc <- new("seurat", raw.data = pbmc.comb)

pbmc <- Setup(pbmc, min.cells = 1, min.genes = 1, do.logNormalize = FALSE, do.scale=FALSE,
              do.center = FALSE, project = "10X_PBMC")

## Build SNN
k.param = 10
k.scale = 10
n.cells = 17302
data.use <- getW(zinb_res)
my.knn <- FNN::get.knn(as.matrix(data.use), k = min(k.scale * k.param, n.cells - 1))
nn.ranked <- cbind(1:n.cells, my.knn$nn.index[, 1:(k.param-1)])
nn.large <- my.knn$nn.index

w <- Seurat:::CalcSNNDense(pbmc, n.cells, nn.large, nn.ranked, prune.SNN = 1/15, print.output = FALSE)
pbmc@snn.k <- k.param
pbmc@snn.dense <- w
pbmc@snn.sparse <- sparseMatrix(1, 1, x = 1)

## Run modularity clustering
SNN.use <- pbmc@snn.dense
resolution <- 0.4
pbmc <- Seurat:::RunModularityClustering(pbmc, SNN.use, modularity = 1, r = resolution,
                               algorithm = 1, n.start = 100, n.iter = 10, random.seed = 0,
                               print.output = FALSE, temp.file.location = NULL)
pbmc <- Seurat:::GroupSingletons(pbmc, SNN.use)
name <- paste("res.", resolution, sep = "")
pbmc <- StashIdent(pbmc, name)

z_cl <- pbmc@ident
names(z_cl) <- paste0(names(pbmc@ident), "-1")

table(z_cl)

plot(data.use, pch=19, col=pal[z_cl])
colnames(data.use) <- paste0("W", 1:NCOL(W))
rownames(data.use) <- names(z_cl)
write.table(data.frame(data.use, paste0("Cluster", z_cl)), sep="\t", quote=FALSE,
            file = "zinb_tenx_combined_clusters.txt")
```

```{r}
data.use <- read.table("zinb_tenx_combined_clusters.txt")
z_cl <- data.use[,11]
plot(tsne_zinb$Y, pch=19, col=pal[z_cl], xlab="TSNE 1", ylab="TSNE 2", main="t-SNE (ZINB-WaVE)")
plot(tsne_data$Y, pch=19, col=pal[z_cl], xlab="TSNE 1", ylab="TSNE 2", main="t-SNE (PCA)")
```


# Session Info

```{r}
sessionInfo()
```
