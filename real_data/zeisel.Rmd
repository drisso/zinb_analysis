---
title: "Analysis of Zeisel et al. data"
author: "Davide Risso"
date: "10/21/2016"
output: 
  html_document: 
    fig_height: 7
    fig_width: 7
    toc: yes
    code_folding: hide
    toc_float: yes
---

```{r options, echo=FALSE, results="hide",mesasge=FALSE, error=FALSE, include=FALSE, autodep=TRUE}
knitr::opts_chunk$set(fig.align="center", cache=TRUE, error=FALSE, message=FALSE, warning=TRUE)
library(SummarizedExperiment)
library(scRNAseq)
library(zinb)
library(ggplot2)
library(magrittr)
library(matrixStats)
library(Rtsne)
library(scone)
library(RColorBrewer)
set.seed(20)
```

## TL;DR

Applying our zero-inflated model to the data from Zeisel et al. (2015). The data are from the mouse cortex and hippocampus. We have information about the tissue of origin and about the clusters found by the authors.

## Unnormalized data

I will focus on the top 1,000 most variable genes. Note that the data are not public, hence it should not work other than on Davide's computer.

```{r datain}
data <- read.table("expression_mRNA_17-Aug-2014.txt", sep='\t', stringsAsFactors = FALSE, comment.char = '%')

tissue <- as.factor(as.matrix(data)[1,-(1:2)])
table(tissue)
group <- as.factor(as.matrix(data)[2,-(1:2)])
table(tissue, group)
nmolecule <- as.numeric(as.matrix(data)[3,-(1:2)])
sex <- as.factor(as.matrix(data)[5,-(1:2)])
table(tissue, sex)
level1 <- as.factor(as.matrix(data)[9,-(1:2)])
level2 <- as.factor(as.matrix(data)[10,-(1:2)])
table(level1)
table(level1, level2)

counts <- as.matrix(data[12:NCOL(data),-(1:2)])
counts <- matrix(as.numeric(counts), ncol=ncol(counts), nrow=nrow(counts))
rownames(counts) <- data[12:NCOL(data),1]
colnames(counts) <- data[8, -(1:2)]
```

To speed up the computations, I will focus on the top 1,000 most variable genes.

```{r filtering}
vars <- rowVars(log1p(counts))
names(vars) <- rownames(counts)
vars <- sort(vars, decreasing = TRUE)
core <- counts[names(vars)[1:1000],]
```

## PCA

First, let's look at PCA (of the log counts) for reference.

```{r pca}
par(mfrow=c(2, 2))
detection_rate <- colSums(core>0)
coverage <- colSums(core)

col1 <- brewer.pal(9, "Set1")
col2 <- brewer.pal(8, "Set2")

colTissue <- col1[tissue]
colMerged <- col2[level1]

pca <- prcomp(t(log1p(core)))
plot(pca$x, col=colMerged, pch=20, main="PCA of log-counts, centered not scaled")
legend("topleft", levels(level1), fill=col2)
plot(pca$x, col=colTissue, pch=20, main="PCA of log-counts, centered not scaled")

fq <- EDASeq::betweenLaneNormalization(counts, which="full")

pcafq <- prcomp(t(log1p(fq[rownames(core),])))
plot(pcafq$x, col=colMerged, pch=20, main="PCA of FQ log-counts, centered not scaled")
plot(pcafq$x, col=colTissue, pch=20, main="PCA of FQ log-counts, centered not scaled")
```

The first plot is the unnormalized data and the second plot is after full-quantile normalization, which is what Russell and Diya used for the paper.

They found that to fully explain the differences between clusters, we need three dimensions.

```{r pca3}
pairs(pcafq$x[,1:3], col=colMerged, pch=20, main="PCA of FQ log-counts, centered not scaled")
```

```{r pca_cor}
df <- data.frame(PC1=pcafq$x[,1], PC2=pcafq$x[,2], detection_rate=detection_rate, coverage=coverage)
pairs(df, pch=20, col=colMerged)

print(cor(df, method="spearman"))
```

Even after full-quantile normalization, there is some residual correlation between PC2 and detection rate.

## ZINB

```{r zinb}
print(system.time(zinb_Vall <- zinbFit(core, ncores = 3, K = 3)))
```

```{r zinb_plot}
pairs(zinb_Vall@W, col=colMerged, pch=20, main="ZINB")
pairs(zinb_Vall@W, col=colTissue, pch=20, main="ZINB")
```

```{r gamma}
df <- data.frame(W1=zinb_Vall@W[,1], W2=zinb_Vall@W[,2], W3=zinb_Vall@W[,3], gamma_mu = zinb_Vall@gamma_mu[1,], gamma_pi = zinb_Vall@gamma_pi[1,], detection_rate=detection_rate, coverage=coverage)
pairs(df, pch=20, col=colMerged)

print(cor(df, method="spearman"))
```

## Four dimensions

```{r zinb_four}
print(system.time(zinb_4 <- zinbFit(core, ncores = 3, K = 4)))
```

```{r four_plot}
pairs(zinb_4@W, col=colMerged, pch=20, main="ZINB by cluster (level 1)")
pairs(zinb_4@W, col=colTissue, pch=20, main="ZINB by tissue")
pairs(zinb_4@W, col=col2[group], pch=20, main="ZINB by group")
```

## Looking at subsets of cells

```{r subcluster}
col3 <- c(rgb(0, 0, 0, alpha = 0), read.table("colors.txt", stringsAsFactors = FALSE, comment.char = "%")[,1])
plot(zinb_Vall@W, col=col3[level2], pch=20, main="ZINB")
plot(pcafq$x, col=col3[level2], pch=20, main="PCA (FQ)")
```

```{r zinb_sub}
i <- 7
idx <- which(level1==levels(level1)[i])
print(system.time(zinb_sub <- zinbFit(core[,idx], ncores = 3, K = 2)))
```

```{r plot_sub}
plot(zinb_sub@W, xlab="W1", ylab="W2", pch=19, col=col3[level2[idx]])
legend("bottomright", levels(droplevels(level2[idx])), fill=unique(col3[level2[idx]]))
```

```{r zinb_sub2}
i <- 6
idx <- which(level1==levels(level1)[i])
print(system.time(zinb_sub <- zinbFit(core[,idx], ncores = 3, K = 2)))
```

```{r plot_sub2}
plot(zinb_sub@W, xlab="W1", ylab="W2", pch=19, col=col3[level2[idx]])
legend("bottomright", levels(droplevels(level2[idx])), fill=unique(col3[level2[idx]]))
```
