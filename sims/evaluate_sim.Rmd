---
title: "Evaluate simulations"
author: "Fanny, Davide, Sandrine"
date: "12/13/2016"
output: 
  html_document: 
    fig_height: 10
    fig_width: 10
    toc: yes
    code_folding: hide
    toc_float: yes
---
```{r options, echo=FALSE, results="hide",message=FALSE, error=FALSE, include=FALSE, autodep=TRUE}
knitr::opts_chunk$set(fig.align="center", cache=TRUE, error=FALSE, message=FALSE, warning=TRUE, fig.width=6, fig.height=6)
library(zinb)
library(cluster)
library(RColorBrewer)
library(ggplot2)
library(reshape)
library(EDASeq)
library(edgeR)
cols <- brewer.pal(8, "Set1")
cols2 <- c(brewer.pal(8, "Set2"), brewer.pal(8, "Set3"), brewer.pal(8, "Set1"))
```

# Description of the simulations

Here we simulate from the true model, with the following parameters.

- 2 unknown factors in W
- V intercept
- X intercept
- Genewise dispersion

To have realistic values for the parameters, we estimated the values starting from the allen dataset, randomly selecting 100 cells.  

For each simulated data, we fit a ZINB model with all the possible combinations (16) of the following parameters:

- Dimension of W: 1 through 4
- V intercept: yes, no
- Dispersion: common, genewise

# Estimates 
See bias, variance, and MSE in separate Rmd files (simAllen_estimates_25.Rmd, simAllen_estimates_5.Rmd, and simAllen_estimates_75.Rmd).

ERRORS with zero fraction = 75%.

# Impact on dimensionality reduction
```{r corr}
load("./datasets/sim_allen5_dist.rda")
corr5 <- lapply(8:14, function(i) rowMeans(sapply(res, function(x) x[[i]])))
corr5 = do.call(cbind, corr5)
corr5 = data.frame(corr5, stringsAsFactors = F)
colnames(corr5) <- c(paste0("zinb k=", 1:4), "FQ PCA (k=2)", "true W", 'ZIFA (k=2)')
corr5$pzero = .5
boxplot(corr5[,c(6, 1:5, 7)], main="Correlation between true and estimated sample distances in W\npzero = 0.5", border=c(3, 1, 2, 1, 1, 1, 1), xlab="method", ylab="Correlation", las=2)
abline(h=1,lty = 2)

load("./datasets/sim_allen25_dist.rda")
corr25 <- lapply(8:14, function(i) rowMeans(sapply(res, function(x) x[[i]])))
corr25 = do.call(cbind, corr25)
corr25 = data.frame(corr25, stringsAsFactors = F)
colnames(corr25) <- c(paste0("zinb k=", 1:4), "FQ PCA (k=2)", "true W", 'ZIFA (k=2)')
corr25$pzero = .25
boxplot(corr25[,c(6, 1:5, 7)], main="Correlation between true and estimated sample distances in W\npzero = 0.25", border=c(3, 1, 2, 1, 1, 1, 1), xlab="method", ylab="Correlation", las=2)
abline(h=1,lty = 2)

load("./datasets/sim_allen75_dist.rda")
corr75 <- lapply(c(8,9,12:14), function(i) rowMeans(sapply(res, function(x) x[[i]])))
corr75 = do.call(cbind, corr75)
corr75 = data.frame(corr75, stringsAsFactors = F)
colnames(corr75) <- c(paste0("zinb k=", 1:2), "FQ PCA (k=2)", "true W", 'ZIFA (k=2)')
corr75$pzero = .75
boxplot(corr75[,c(4, 1:3, 5)], main="Correlation between true and estimated sample distances in W\npzero = 0.75", border=c(3, 1, 2, 1, 1, 1, 1), xlab="method", ylab="Correlation", las=2)
abline(h=1,lty = 2)

corr = rbind(corr5, corr25)
corr = melt(corr, id.vars = 'pzero')
ggplot(corr, aes(x = variable, y= value, col = variable)) + geom_boxplot() +
  facet_grid(~ pzero) + ggtitle('Correlation between true and estimated sample distances in W') + ylab('Correlation') + xlab('Method')

ggplot(corr, aes(x = factor(pzero), y= value, col = factor(pzero))) +
  geom_boxplot() + facet_grid(~ variable) + ggtitle('Correlation between true and estimated sample distances in W') + ylab('Correlation') + xlab('Method')
```

## Silhouette width
```{r sil}
load("./datasets/sim_allen5_dist.rda")
sil5 <- lapply(15:21, function(i) rowMeans(sapply(res, function(x) x[[i]])))
sil5 = do.call(cbind, sil5)
sil5 = data.frame(sil5,stringsAsFactors = F)
colnames(sil5) <- c(paste0("zinb k=", 1:4), "FQ PCA (k=2)", 'true W', "ZIFA (k=2)")
sil5$pzero = .5
boxplot(sil5[,c(6, 1:5, 7)],
        main="Silhouette width of true labels\npzero = 0.5",
        border=c(3, 1, 2, 1, 1, 1, 1), xlab="", ylab="Silhouette width", las=2)
abline(h = 1, lty = 2)
boxplot(sil5[,6] - sil5[,c(6, 1:5, 7)],
        main="Difference of Silhouette width of true labels\npzero = 0.5",
        border=c(3, 1, 2, 1, 1, 1, 1), xlab="", ylab="Silhouette width", las=2)
abline(h = 0, lty = 2)

load("./datasets/sim_allen25_dist.rda")
sil25 <- lapply(15:21, function(i) rowMeans(sapply(res, function(x) x[[i]])))
sil25 = do.call(cbind, sil25)
sil25 = data.frame(sil25,stringsAsFactors = F)
colnames(sil25) <- c(paste0("zinb k=", 1:4), "FQ PCA (k=2)", 'true W', "ZIFA (k=2)")
sil25$pzero = .25
boxplot(sil25[,c(6, 1:5, 7)],
        main="Silhouette width of true labels\npzero = 0.25",
        border=c(3, 1, 2, 1, 1, 1, 1), xlab="", ylab="Silhouette width", las=2)
abline(h = 1, lty = 2)
boxplot(sil25[,6] - sil25[,c(6, 1:5, 7)],
        main="Difference of Silhouette width of true labels\npzero = 0.25",
        border=c(3, 1, 2, 1, 1, 1, 1), xlab="", ylab="Silhouette width", las=2)
abline(h = 0, lty = 2)

load("./datasets/sim_allen75_dist.rda")
sil75 <- lapply(c(15, 16, 19:21), function(i) rowMeans(sapply(res, function(x) x[[i]])))
sil75 = do.call(cbind, sil75)
sil75 = data.frame(sil75,stringsAsFactors = F)
colnames(sil75) <- c(paste0("zinb k=", 1:2), "FQ PCA (k=2)", 'true W', "ZIFA (k=2)")
sil75$pzero = .75
boxplot(sil75[,c(4, 1:3, 5)],
        main="Silhouette width of true labels\npzero = 0.75",
        border=c(3, 1, 2, 1, 1, 1, 1), xlab="", ylab="Silhouette width", las=2)
abline(h = 1, lty = 2)
boxplot(sil75[,4] - sil75[,c(4, 1:3, 5)],
        main="Difference of Silhouette width of true labels\npzero = 0.75",
        border=c(3, 1, 2, 1, 1, 1, 1), xlab="", ylab="Silhouette width", las=2)
abline(h = 0, lty = 2)


sil = rbind(sil25, sil5)
sil = melt(sil, id.vars = 'pzero')
ggplot(sil, aes(x = variable, y= value, col = variable)) + geom_boxplot() +
  facet_grid(~ pzero) + ggtitle('Silhouette width of true labels') + ylab('Silhouette width') + xlab('')

ggplot(sil, aes(x = factor(pzero), y= value, col = factor(pzero))) +
  geom_boxplot() + facet_grid(~ variable) + ggtitle('Silhouette width of true labels') + ylab('Silhouette width') + xlab('')
```

```{r pcaK2}
load('./datasets/sim_allen25.rda')
load('./datasets/sim_allen25_fitted.rda')
load('./datasets/sim_allen25_zifa.rda')
biotrue = factor(bio)
fit = fittedSim[[2]][[1]][[2]][[1]]
fq <- betweenLaneNormalization(t(simData[[1]]$counts), which="full")
pca <- prcomp(t(log1p(fq)))
par(mfrow=c(1,3))
plot(pca$x, col = biotrue, main = 'PCA\nfZero = 0.25')
plot(fit@W, col = biotrue, main = 'Estimated W, k = 2\nfZero = 0.25', 
     xlab = 'W1', ylab = 'W2')
plot(zifa[[1]], col = biotrue, main = 'ZIFA\nfZero = 0.25')

load('./datasets/sim_allen5.rda')
load('./datasets/sim_allen5_fitted.rda')
load('./datasets/sim_allen5_zifa.rda')
fit = fittedSim[[2]][[1]][[2]][[1]]
fq <- betweenLaneNormalization(t(simData[[1]]$counts), which="full")
pca <- prcomp(t(log1p(fq)))
par(mfrow=c(1,3))
plot(pca$x, col = biotrue, main = 'PCA\nfZero = 0.5')
plot(fit@W, col = biotrue, main = 'Estimated W, k = 2\nfZero = 0.5', 
     xlab = 'W1', ylab = 'W2')
plot(zifa[[1]], col = biotrue, main = 'ZIFA\nfZero = 0.5')

load('./datasets/sim_allen75.rda')
load('./datasets/sim_allen75_fitted.rda')
load('./datasets/sim_allen75_zifa.rda')
fit = fittedSim[[2]][[1]][[2]][[1]]
fq <- betweenLaneNormalization(t(simData[[1]]$counts), which="full")
pca <- prcomp(t(log1p(fq)))
par(mfrow=c(1,3))
plot(pca$x, col = biotrue, main = 'PCA\nfZero = 0.75')
plot(fit@W, col = biotrue, main = 'Estimated W, k = 2\nfZero = 0.75', 
     xlab = 'W1', ylab = 'W2')
plot(zifa[[1]], col = biotrue, main = 'ZIFA\nfZero = 0.75')
```

## Model fit
Let's look at model fit when chosen parameters are correct (V, genewise dispersion, K=2).

From Sandrine's slide.

Mean, variance, and zero probability for the ZINB model are
$$E[Y_{i,j}] = (1 - \pi_{i,j})\mu_{i,j},$$
$$var(Y_{i,j}) = (1 - \pi_{i,j})\mu_{i,j}(1 + \mu_{i,j}(\phi_j + \pi_{i,j})),$$
$$P(Y_{i,j} = 0) = \pi_{i,j} + (1 - \pi_{i,j})(1 + \phi_j \mu_{i,j})^{\frac{1}{\phi_j}}.$$

For the NB model, $\pi_{i,j}=0$. We fitted the NB using edgeR after full quantile normalization.

### Zero Fraction 50%
```{r helperFit}
computeExp <- function(zinbModel, model = 'zinb'){
  if (model == 'zinb'){
    (1 - t(getPi(zinbModel))) * t(getMu(zinbModel))
  }else{
    t(getMu(zinbModel))
  }
}

computeVar <- function(zinbModel, model = 'zinb'){
  mu = t(getMu(zinbModel))
  pi = t(getPi(zinbModel))
  phi = exp(-getZeta(zinbModel))
  if (model == 'zinb'){
    (1 - pi) * mu * (1 + mu*(phi + pi))
  }else{
    mu * (1 + mu*phi)
  }
}

computeP0 <- function(zinbModel, model = 'zinb'){
  mu = t(getMu(zinbModel))
  pi = t(getPi(zinbModel))
  phi = exp(-getZeta(zinbModel))
  if (model == 'zinb'){
    pi + (1 - pi) * (1 + phi * mu) ^ (-1/phi)
  }else{
    (1 + phi * mu) ^ (-1/phi)
  }
}

plotMD <- function(x, y, xlim = c(0,10), ylim = c(-5, 5),
                   main = 'ZINB: MD-plot estimated vs. observed mean count, log scale'){
  mm = .5*(x + y)
  dd = x - y
  smoothScatter(mm, dd, xlim = xlim, ylim = ylim, xlab = 'Mean', ylab = 'Diff', main = main)
  abline(h = 0, col = 'gray')
  fit = loess(dd ~ mm)
  xpred = seq(0, 10, .1)
  pred = predict(fit, xpred)
  lines(xpred, pred, col = 'red', type = 'l', lwd=2)
}

fitNB <- function(rda, i = 1){
  load(rda)
  counts = t(simData[[i]]$counts)
  phenoData = data.frame(bio, row.names=colnames(originalCounts))
  set = newSeqExpressionSet(counts, phenoData = phenoData)
  fq = betweenLaneNormalization(set, which = "full", offset = T)
  disp = estimateDisp(counts(fq), offset = -offst(fq)) 
  fit = glmFit(counts(fq), dispersion = disp$tagwise.dispersion, offset = -offst(fq))
  list(fitted = fit$fitted.values, disp = disp$tagwise.dispersion)
}
```

There is one outlier for zinb fit.
```{r modelfit50}
# zinb
load('./datasets/sim_allen5_fitted.rda')
load('./datasets/sim_allen5.rda')
zz = fittedSim[[2]][[1]][[2]][[1]]
zinbEY = log(rowMeans(computeExp(zz, model = 'zinb')))
zinbPY0 = rowMeans(computeP0(zz, model = 'zinb'))
# observed
logAveCount = log(rowMeans(originalCounts))
prop0 = rowMeans(originalCounts == 0)
# edgeR
nb50 = fitNB('./datasets/sim_allen5.rda')
nbEY = log(rowMeans(nb50$fitted))
nbPY0 = rowMeans((1 + nb50$fitted * nb50$disp)^(-1/nb50$disp))
```

MD-plot estimated vs. observed mean count, log scale, zoomed (we do not see the outlier)
```{r meanCount50}
par(mfrow=c(1,2))
plotMD(logAveCount, zinbEY, xlim = c(4, 9), ylim = c(-5, 5),
       main = 'ZINB')
plotMD(logAveCount, nbEY, xlim = c(4, 9), ylim = c(-5, 5),
       main = 'NB')
```

MD-plot estimated vs. observed zero probability
```{r zeroProb50}
par(mfrow=c(1,2))
plotMD(prop0, zinbPY0, xlim = c(0, 1), ylim = c(-.6, .6),
       main = 'ZINB')
plotMD(prop0, nbPY0, xlim = c(0, 1), ylim = c(-.6, .6), 
       main = 'NB')
```

```{r obszero50}
par(mfrow=c(1,2))
smoothScatter(logAveCount, rowMeans(originalCounts == 0),
              xlab = 'log average count', xlim = c(2,10),
              ylab = 'proportion of zeros', ylim = c(0,1),
              main = 'Zero probability versus Mean')
fit = loess(zinbPY0 ~ zinbEY)
xpred = seq(2,9,.1)
pred = predict(fit, xpred)
lines(xpred, pred,col='green',type = 'l', lwd=2, ylim = c(0,1), xlim = c(2,10))
fit = loess(nbPY0 ~ nbEY)
xpred = seq(2,9,.1)
pred = predict(fit, xpred)
lines(xpred, pred,col='red', type='l', lwd=2, ylim = c(0,1), xlim = c(2,10))
fit = loess(rowMeans(originalCounts == 0) ~ logAveCount)
xpred = seq(2,9,.1)
pred = predict(fit, xpred)
lines(xpred, pred,col = 'blue',type = 'l',lwd=2, ylim = c(0,1), xlim = c(2,10))
legend('topright', c('observed', 'zinb', 'nb'), 
   lty=1, col=c('blue', 'green', 'red'), bty='n', cex=.75)

smoothScatter(nbEY, nbPY0,
              xlab = 'fitted log average count (edgeR)', xlim = c(2,10),
              ylab = 'estimated proportion of zeros (edgeR)', ylim = c(0,1),
              main = 'Zero probability versus Mean - edgeR')
fit = loess(nbPY0 ~ nbEY)
xpred = seq(2,9,.1)
pred = predict(fit, xpred)
lines(xpred, pred,col='red', type='l', lwd=2, ylim = c(0,1), xlim = c(2,10))
legend('topright', c('nb'), lty=1, col=c('red'), bty='n', cex=.75)
```

```{r disp50}
par(mfrow = c(1, 2))
smoothScatter(rowMeans(originalCounts == 0), nb50$disp, xlim = c(0,1), 
              xlab = 'Observed zero probability',ylim = c(0, 30),
              ylab = 'Estimated dispersion',
              main = 'NB: dispersion versus zero probability')
xpred = seq(0, 1, .05)
fitzinb = loess(exp(-zz@zeta) ~ rowMeans(originalCounts == 0))
predzinb = predict(fitzinb, xpred)
fitnb = loess(nb50$disp ~ rowMeans(originalCounts == 0))
prednb = predict(fitnb, xpred)
lines(xpred, predzinb, col = 'green', type = 'l', lwd=2)
lines(xpred, prednb, col = 'red', type = 'l', lwd=2)
legend('topright',c('zinb','nb'),lty=1,col=c('green','red'), bty='n', cex=.75)

smoothScatter(rowMeans(originalCounts == 0), exp(-zz@zeta),xlim = c(0,1), 
              xlab = 'Observed zero probability',ylim = c(0, 30),
              ylab = 'Estimated dispersion',
              main = 'ZINB: dispersion versus zero probability')
lines(xpred, predzinb, col = 'green', type = 'l', lwd=2)
lines(xpred, prednb, col = 'red', type = 'l', lwd=2)
legend('topright',c('zinb','nb'),lty=1,col=c('green','red'), bty='n', cex=.75)

smoothScatter(rowMeans(originalCounts == 0), exp(-simModel@zeta),
              xlab = 'Observed zero probability',ylim = c(0, 30),
              ylab = 'Estimated dispersion',xlim = c(0,1), 
              main = 'ZINB: dispersion versus zero probability')
lines(xpred, predzinb, col = 'green', type = 'l', lwd=2)
lines(xpred, prednb, col = 'red', type = 'l', lwd=2)
legend('topright',c('zinb','nb'),lty=1,col=c('green','red'), bty='n', cex=.75)
```

