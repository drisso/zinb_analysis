---
title: "Preliminary simulations"
author: "Davide and Fanny"
date: "10/31/2016"
output: html_document
---

```{r options, echo=FALSE, results="hide",mesasge=FALSE, error=FALSE, include=FALSE, autodep=TRUE}
knitr::opts_chunk$set(fig.align="center", cache=TRUE, error=FALSE, message=FALSE, warning=TRUE)
library(zinb)
library(cluster)

library(RColorBrewer)
cols <- brewer.pal(8, "Set1")
cols2 <- c(brewer.pal(8, "Set2"), brewer.pal(8, "Set3"), brewer.pal(8, "Set1"))
```

## Description of the simulations

Here we simulate from the true model, with the following parameters.

- 2 unknown factors in W
- V intercept
- X intercept
- Common dispersion

To have realistic values for the parameters, we estimated the values starting from the allen dataset, randomly selecting 100 cells and using only the top 1,000 most variable genes.

For each simulated data, we fit a ZINB model with all the possible combinations (32) of the following parameters:

- Dimension of W: 1 through 4
- V intercept: yes, no
- X intercept: yes, no
- Dispersion: common, genewise

This is obviously just one simulation setting, we will need to simulate data with genewise dispersion, no intercepts, etc.

## Results

### Explore the results for one simulated matrix

```{r one_sim}
load("k2_Xintercept_Vintercept.rda")
load("k2_Xintercept_Vintercept_first.rda")
true_W <- sim_obj@W
dtrue <- as.matrix(dist(true_W))
pamtrue <- pam(dtrue, k=3)$clustering

plot(true_W, pch=19, col=pamtrue, main="True W", xlab="W1", ylab="W2")
plot(fit[[1]]@W, rep(0, NROW(true_W)), pch=19, col=pamtrue, main="K=1", xlab="W1", ylab="")
plot(fit[[2]]@W, pch=19, col=pamtrue, main="K=2", xlab="W1", ylab="W2")
pairs(fit[[3]]@W, pch=19, col=pamtrue, main="K=3")
pairs(fit[[4]]@W, pch=19, col=pamtrue, main="K=4")
```

### Bias

```{r bias}
load("k2_Xintercept_Vintercept_bias.rda")
K <- 1:4

beta_mu <- plotbias[grepl("beta_mu", names(plotbias), fixed = TRUE) &
                       grepl(".X.V.common_disp", names(plotbias), fixed=TRUE)]
names(beta_mu) <- paste0("K", K)
boxplot(beta_mu, las=2, main="Beta_mu", ylab="Bias")
abline(h=0, col=2)

beta_pi <- plotbias[grepl("beta_pi", names(plotbias), fixed = TRUE) &
                       grepl(".X.V.common_disp", names(plotbias), fixed=TRUE)]
names(beta_pi) <- paste0("K", K)
boxplot(beta_pi, las=2, main="Beta_pi", ylab="Bias")
abline(h=0, col=2)

gamma_mu <- plotbias[grepl("gamma_mu", names(plotbias), fixed = TRUE) &
                       grepl(".X.V.common_disp", names(plotbias), fixed=TRUE)]
names(gamma_mu) <- paste0("K", K)
boxplot(gamma_mu, las=2, main="Gamma_mu", ylab="Bias")
abline(h=0, col=2)

gamma_pi <- plotbias[grepl("gamma_pi", names(plotbias), fixed = TRUE) &
                       grepl(".X.V.common_disp", names(plotbias), fixed=TRUE)]
names(gamma_pi) <- paste0("K", K)
boxplot(gamma_pi, las=2, main="Gamma_pi", ylab="Bias")
abline(h=0, col=2)

theta <- plotbias[grepl("theta", names(plotbias), fixed=TRUE) &
                  grepl(".X.V.", names(plotbias), fixed=TRUE)]
names(theta) <- sapply(strsplit(names(theta), ".", fixed=TRUE), function(x) paste(x[1], collapse="_"))
boxplot(theta, outline=TRUE, las=2, main="Theta", ylab="Bias")
abline(h=0, col=2)

walpha_mu <- plotbias[grepl("walpha_mu", names(plotbias), fixed=TRUE)]
names(walpha_mu) <- sapply(strsplit(names(walpha_mu), ".", fixed=TRUE), function(x) paste(x[1:3], collapse="_"))
boxplot(walpha_mu, outline=FALSE, las=2, main="W * alpha_mu", ylab="Bias")
abline(h=0, col=2)

walpha_mu <- plotbias[grepl("walpha_mu", names(plotbias), fixed=TRUE) &
                      grepl(".X.V.common_disp", names(plotbias), fixed=TRUE)]
names(walpha_mu) <- sapply(strsplit(names(walpha_mu), ".", fixed=TRUE), function(x) paste(x[1], collapse="_"))
boxplot(walpha_mu, outline=TRUE, las=2, main="W * alpha_mu", ylab="Bias")
abline(h=0, col=2)
boxplot(walpha_mu, outline=FALSE, las=2, main="W * alpha_mu", ylab="Bias")
abline(h=0, col=2)

walpha_pi <- plotbias[grepl("walpha_pi", names(plotbias), fixed=TRUE)]
names(walpha_pi) <- sapply(strsplit(names(walpha_pi), ".", fixed=TRUE), function(x) paste(x[1:3], collapse="_"))
boxplot(walpha_pi, outline=FALSE, las=2, main="W * alpha_pi", ylab="Bias")
abline(h=0, col=2)

walpha_pi <- plotbias[grepl("walpha_pi", names(plotbias), fixed=TRUE) &
                        grepl(".X.V.common_disp", names(plotbias), fixed=TRUE)]
names(walpha_pi) <- sapply(strsplit(names(walpha_pi), ".", fixed=TRUE), function(x) paste(x[1], collapse="_"))
boxplot(walpha_pi, outline=TRUE, las=2, main="W * alpha_pi", ylab="Bias")
abline(h=0, col=2)
boxplot(walpha_pi, outline=FALSE, las=2, main="W * alpha_pi", ylab="Bias")
abline(h=0, col=2)

mu <- plotbias[grepl(".mu", names(plotbias), fixed=TRUE)]
names(mu) <- sapply(strsplit(names(mu), ".", fixed=TRUE), function(x) paste(x[1:3], collapse="_"))
boxplot(mu, outline=FALSE, las=2, main="Mu", ylab="Bias")
abline(h=0, col=2)

mu <- plotbias[grepl(".X.V.common_disp.mu", names(plotbias), fixed=TRUE)]
names(mu) <- sapply(strsplit(names(mu), ".", fixed=TRUE), function(x) paste(x[1], collapse="_"))
boxplot(mu, outline=TRUE, las=2, main="Mu", ylab="Bias")
abline(h=0, col=2)
boxplot(mu, outline=FALSE, las=2, main="Mu", ylab="Bias")
abline(h=0, col=2)

pi <- plotbias[grepl(".pi", names(plotbias), fixed=TRUE)]
names(pi) <- sapply(strsplit(names(pi), ".", fixed=TRUE), function(x) paste(x[1:3], collapse="_"))
boxplot(pi, outline=FALSE, las=2, main="Pi", ylab="Bias")
abline(h=0, col=2)

pi <- plotbias[grepl(".X.V.common_disp.pi", names(plotbias), fixed=TRUE)]
names(pi) <- sapply(strsplit(names(pi), ".", fixed=TRUE), function(x) paste(x[1], collapse="_"))
boxplot(pi, outline=TRUE, las=2, main="Pi", ylab="Bias")
abline(h=0, col=2)
boxplot(pi, outline=FALSE, las=2, main="Pi", ylab="Bias")
abline(h=0, col=2)
```

### Distance and clustering

```{r corr}
load("k2_Xintercept_Vintercept_dist.rda")

corr <- sapply(6:9, function(i) rowMeans(sapply(res, function(x) x[[i]])))
boxplot(corr, main="Correlation between true and estimated sample distances in W", border=c(1, 2, 1, 1), xlab="k", ylab="Correlation")

corr <- sapply(6:10, function(i) rowMeans(sapply(res, function(x) x[[i]])))
colnames(corr) <- c(paste0("zinb k=", 1:4), "FQ PCA (k=2)")
boxplot(corr, main="Correlation between true and estimated sample distances in W", border=c(1, 2, 1, 1), xlab="method", ylab="Correlation", las=2)

sil <- sapply(11:14, function(i) rowMeans(sapply(res, function(x) x[[i]])))
boxplot(sil, main="Silhouette width of the PAM clustering based on true W", border=c(1, 2, 1, 1),  xlab="k", ylab="Silhouette width")

sil <- sapply(11:15, function(i) rowMeans(sapply(res, function(x) x[[i]])))
colnames(sil) <- c(paste0("zinb k=", 1:4), "FQ PCA (k=2)")
boxplot(sil, main="Silhouette width of the PAM clustering based on true W", border=c(1, 2, 1, 1),  xlab="method", ylab="Silhouette width", las=2)
```


