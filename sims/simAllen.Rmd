---
title: "Simulations from Allen"
author: "Fanny, Davide, Sandrine"
date: "11/27/2016"
output: 
  html_document: 
    fig_height: 10
    fig_width: 10
    toc: yes
    code_folding: hide
    toc_float: yes
---

```{r options, echo=FALSE, results="hide",mesasge=FALSE, error=FALSE, include=FALSE, autodep=TRUE}
knitr::opts_chunk$set(fig.align="center", cache=TRUE, error=FALSE,
                      message=FALSE, warning=TRUE, fig.width=6, fig.height=6)
library(SummarizedExperiment)
library(scRNAseq)
library(zinb)
library(scran)
library(EDASeq)
library(ggplot2)
library(magrittr)
library(matrixStats)
library(reshape)
library(ggplot2)
library(edgeR)
library(RColorBrewer)
require(knitr)
cols <- brewer.pal(8, "Set1")
cols2 <- c(brewer.pal(8, "Set2"), brewer.pal(8, "Set3"), brewer.pal(8, "Set1"))
set.seed(975)
```

```{r fct}
zinbModelFromW <- function(counts, sim_W){
  mod <- model.matrix(~ sim_W)
  zinb_sim <- zinbFit(counts, ncores = 3, X=mod, which_X_mu=1:3, which_X_pi=1:3,
                      commondispersion=FALSE)
  true_alpha_mu <- zinb_sim@beta_mu[-1,]
  true_alpha_pi <- zinb_sim@beta_pi[-1,]
  true_beta_mu <- zinb_sim@beta_mu[1,,drop=FALSE]
  true_beta_pi <- zinb_sim@beta_pi[1,,drop=FALSE]
  true_gamma_mu <- zinb_sim@gamma_mu
  true_gamma_pi <- zinb_sim@gamma_pi
  true_zeta <- zinb_sim@zeta
  zinbModel(W=sim_W, alpha_mu=true_alpha_mu, alpha_pi=true_alpha_pi,
            beta_mu=true_beta_mu, beta_pi=true_beta_pi,
            zeta = true_zeta, gamma_mu=true_gamma_mu,
            gamma_pi=true_gamma_pi)
}

zinbSimFromZinb <- function(simData, simModel, binFactor = 1){
  n = nrow(simData$counts)
  J = ncol(simData$counts)
  pi = getPi(simModel)
  datado = lapply(seq(n*J), function(i) {
    pp = binFactor * pi[i]
    pp = ifelse(pp > 1, 1, pp)
    rbinom(1, size = 1, prob = pp)
    })
  data.dropout = matrix(unlist(datado), nrow = n)
  counts = simData$dataNB * (1 - data.dropout)
  t(counts)
}
```

# Simulation plan
```{r simSummary}
simSummary = data.frame(realData = c(rep('Allen', 2), rep('Zeisel', 2)),
                        K = rep(2, 4),
                        nclusters = c(rep(3, 2), rep(4, 2)),
                        corMuPi = c(rep('no', 2), rep('yes', 2)),
                        dim =  rep('1000x100', 4),
                        zeroFract = rep(c(.35, .7), 2),
                        nreplicates = 10)
kable(simSummary)                    
```

To simulate a dataset, steps are as follow  

1. Fit zinb to filtered counts.    
2. Look at fitted W.  
3. Simulate simW from gaussians.  
4. Fit
$$ln(\mu) =  (1, simW) (\beta_{\mu}, \alpha_{\mu}) + (V\gamma_{\mu})^T,$$
$$\text{logit}(\pi) = (1, simW) (\beta_{\pi}, \alpha_{\pi}) + (V\gamma_{\pi})^T.$$  
5. Create zinb model = zinbModel(simW, $\hat{\beta_{\mu}}$,$\hat{\beta_{\pi}}$, $\hat{\gamma_{\mu}}$, ... ).  
6. Simulate counts zinbSim(model).  

To simulate a dataset with more zeros, follow same steps up to step 6. Then, in step 6, instead of simulating $Z_{i,j} \sim Binom(\pi_{i,j})$, use a factor $F$, and simulate $Z_{i,j} \sim Binom(F \pi_{i,j})$. Use this new $Z$ to simulate new matrix of counts (with more zeros). Finally, use the new matrix of counts to perform steps 4 to 6.  

Using this procedure, we simulate two datasets using the same simulated W but with different number of zeros. For the two datasets, we have the simualated counts and "true" W, gamma_mu, gamma_pi, alpha_mu, alpha_pi, beta_mu, and beta_pi.

# Allen
We want to look at real datasets to simulate realistic datasets.
```{r datain}
data("allen")

prefilter <- allen[grep("^ERCC-", rownames(allen), invert = TRUE),
                    which(colData(allen)$Core.Type=="Core")]
filterGenes <- apply(assay(prefilter) > 10, 1, sum) >= 10
sampleCells <- sample(ncol(prefilter), 100)

postfilter <- prefilter[filterGenes, sampleCells]
bio <- as.factor(colData(postfilter)$driver_1_s)
cl <- as.factor(colData(postfilter)$Primary.Type)
postfilter <- assay(postfilter)

vars <- rowVars(log1p(postfilter))
names(vars) <- rownames(postfilter)
vars <- sort(vars, decreasing = TRUE)
core <- postfilter[names(vars)[1:1000],]
detection_rate <- colSums(core>0)
coverage <- colSums(core)
```

We will color-code the cells by either known cell type or by inferred cluster (inferred in the original study). Remove ERCC spike-ins, filter out the genes that do not have at least 10 counts in at least 10 cells, sample at random 100 cells, select 1,000 most variable genes. Then, dimensions are
```{r}
dim(core)
```

```{r filtering}
par(mfrow = c(1,2))
pal =colorRampPalette(c("black","black", "red","yellow"), space="rgb")
mean = apply(log1p(core), 1, function(x) mean(x[x!=0]))
plot(mean, rowMeans(core == 0), xlim = c(3,8), ylim = c(0,1),
              xlab = "Mean Expression", ylab = "Dropout Rate", 
              main = '1,000 most variable genes')
smoothScatter(mean, rowMeans(core == 0), xlim = c(3,8),
              nrpoints=Inf, pch = "", cex = .7, ylim = c(0,1),
              xlab = "Mean Expression", ylab = "Dropout Rate", 
              colramp = pal, main = '1,000 most variable genes')
```

Fit data with K = 2, V and X intercepts in both Mu and Pi, commondispersion = FALSE, and no covariate.
```{r zinb}
print(system.time(zinb <- zinbFit(core, ncores = 3, K = 2,
                                  commondispersion = FALSE)))
```

# True W
```{r zinb_plot}
par(mfrow=c(1, 2))
plot(zinb@W, col=cols[bio], pch=19, xlab="W1", ylab="W2",
     main="Fitted W, color = known cell-type")
#legend("bottomright", levels(bio), fill=cols)
plot(zinb@W, col=cols2[cl], pch=19, xlab="W1", ylab="W2",
     main="Fitted W, color = inferred clusters")
#legend("topright", levels(cl), fill=cols2)
```

```{r Wdistri}
W = data.frame(W1 = zinb@W[,1], W2 = zinb@W[,1], bio= bio)
ggplot(melt(W), aes(value, fill = bio)) + geom_density(alpha = 0.2) +
  facet_grid(~ variable) + xlab('fitted W') + theme_bw()
```

sim_W simulated with
$$W_1^{Scnn1a} \sim \mathcal{N}(-2, .5)$$
$$W_2^{Scnn1a} \sim \mathcal{N}(-2, .5)$$
$$W_1^{Rbp4} \sim \mathcal{N}(4, .5)$$
$$W_2^{Rbp4} \sim \mathcal{N}(-.5, .5)$$
$$W_1^{Ntsr1} \sim \mathcal{N}(0, .5)$$
$$W_2^{Ntsr1} \sim \mathcal{N}(2.5, .5)$$
```{r Wsim}
Sc = grepl('^Scnn1a', W$bio)
Rb = grepl('^Rbp4', W$bio)
Nt = grepl('^Ntsr1', W$bio)
W[Sc, 'W1sim'] = rnorm(sum(Sc), -2, .5)
W[Sc, 'W2sim'] = rnorm(sum(Sc), -2, .5)
W[Rb, 'W1sim'] = rnorm(sum(Rb), 4, .5)
W[Rb, 'W2sim'] = rnorm(sum(Rb), -.5, .5)
W[Nt, 'W1sim'] = rnorm(sum(Nt), 0, .5)
W[Nt, 'W2sim'] = rnorm(sum(Nt), 2.5, .5)

par(mfrow=c(1, 2))
plot(zinb@W, col=cols[bio], pch=19, xlab="W1", ylab="W2",
     main="Fitted")
plot(W[,c('W1sim', 'W2sim')], col=cols[bio], pch=19, xlab="W1", ylab="W2",
     main="Simulated")
```

```{r trueW}
sim_W <- as.matrix(W[, c('W1sim', 'W2sim')])
```

# Simulate
Two datasets were simulated     

1. from sim_W and real counts -> simData,   
2. from sim_W and simData@counts with additionnal zeros -> simData_more0


```{r simulate}
simModel = zinbModelFromW(core, sim_W)
simData = zinbSim(simModel, seed = 8746)
```

When we filter out the genes that do not have at least 10 counts in at least 10 cells, we get only about 600 genes (not 1,000). Is it a problem? Do you have ideas to solve the problem?
```{r dimMore0}
counts_more0 = zinbSimFromZinb(simData, simModel, 5)
#counts_more0 = counts_more0[rowSums(counts_more0) != 0, ]
counts_more0 = counts_more0[apply(counts_more0 > 10, 1, sum) >= 10, ]
dim(counts_more0)
```

```{r simMore0}
simModel_more0 = zinbModelFromW(counts_more0, sim_W)
simData_more0 = zinbSim(simModel_more0, seed = 8746)
```

```{r zeroFraction}
c(observed = sum(core==0)/(nrow(core) * ncol(core)),
  simulated = simData$zeroFraction,
  sim_more0 = simData_more0$zeroFraction)
```

Same sim_W for the two simulated datasets.
```{r simW}
par(mfrow=c(1, 3))
plot(zinb@W, col=cols[bio], pch=19, xlab="W1", ylab="W2",
     main="Fitted")
plot(simModel@W, col=cols[bio], pch=19, xlab="W1", ylab="W2",
     main="Simulated")
plot(simModel_more0@W, col=cols[bio], pch=19, xlab="W1", ylab="W2",
     main="Simulated with more zeros")
```

```{r simGamma}
df <- data.frame(gamma_mu = simModel@gamma_mu[1, ],
                 gamma_pi = simModel@gamma_pi[1, ],
                 gamma_mu_more0 = simModel_more0@gamma_mu[1, ],
                 gamma_pi_more0 = simModel_more0@gamma_pi[1, ],
                 detection_rate = detection_rate,
                 coverage = coverage)
pairs(df, pch=19, col=cols[bio])
print(cor(df, method="spearman"))
```

```{r simalpha}
df <- data.frame(alpha_mu_1 = simModel@alpha_mu[1, ],
                 alpha_mu_2 = simModel@alpha_mu[2, ],
                 alpha_pi_1 = simModel@alpha_pi[1, ],
                 alpha_pi_2 = simModel@alpha_pi[2, ])
pairs(df, pch=19, main = 'alpha')
print(cor(df, method="spearman"))

df <- data.frame(alpha_mu_1 = simModel_more0@alpha_mu[1, ],
                 alpha_mu_2 = simModel_more0@alpha_mu[2, ],
                 alpha_pi_1 = simModel_more0@alpha_pi[1, ],
                 alpha_pi_2 = simModel_more0@alpha_pi[2, ])
pairs(df, pch=19, main = 'alpha, more zeros')
print(cor(df, method="spearman"))
```

```{r simBeta}
df <- data.frame(beta_mu = simModel@beta_mu[1, ],
                 beta_pi = simModel@beta_pi[1, ])
pairs(df, pch=19, main = 'Beta')
print(cor(df, method="spearman"))

df <- data.frame(beta_mu_more0 = simModel_more0@beta_mu[1, ],
                 beta_pi_more0 = simModel_more0@beta_pi[1, ])
pairs(df, pch=19, main = 'Beta more 0s')
print(cor(df, method="spearman"))
```


```{r newOverall}
obs_detection_rate <- colMeans(core>0)
obs_coverage <- colSums(core)
sim1_detection_rate <- rowMeans(simData$counts>0)
sim1_coverage <- rowSums(simData$counts)
sim2_detection_rate <- rowMeans(simData_more0$counts>0)
sim2_coverage <- rowSums(simData_more0$counts)

par(mfrow=c(3, 2))
plot(rowMeans(getPi(zinb)), obs_detection_rate,
     xlab="Average fitted Pi", ylab="Detection Rate",
     pch=19, col=cols[bio], ylim = c(0, 1), xlim = c(0,1))
plot(rowMeans(log1p(getMu(zinb))), log1p(obs_coverage), xlim = c(5, 8),
     xlab="Average fitted log Mu", ylab="log Coverage", pch=19, ylim = c(9,14),
     col=cols[bio])
plot(rowMeans(getPi(simModel)), sim1_detection_rate,
     xlab="Average simulated Pi", ylab="True Detection Rate",
     pch=19, col=cols[bio], ylim = c(0, 1), xlim = c(0,1))
plot(rowMeans(log1p(getMu(simModel))), log1p(sim1_coverage), xlim = c(5, 8),
     xlab="Average simulated log Mu", ylab="log Coverage", pch=19,
     col=cols[bio],ylim = c(9,14))
plot(rowMeans(getPi(simModel_more0)), sim2_detection_rate,
     xlab="Average simulated Pi", ylab="True Detection Rate",
     pch=19, col=cols[bio], ylim = c(0, 1), xlim = c(0,1))
plot(rowMeans(log1p(getMu(simModel_more0))), log1p(sim2_coverage),
     xlim = c(5, 8), xlab="Average simulated log Mu", ylab="log Coverage",
     pch=19, col=cols[bio], ylim = c(9,14))
```

```{r mupi}
par(mfrow=c(1, 3))
smoothScatter(mean, rowMeans(core == 0),xlim = c(3,8),
              nrpoints=Inf, pch = "", cex = .7, ylim = c(0,1),
              xlab = "Mean Expression", ylab = "Dropout Rate", 
              colramp = pal, main = 'Observed')
smoothScatter(colMeans(log1p(getMu(simModel))), colMeans(getPi(simModel)), nbin = 256,
              nrpoints=Inf, pch="", cex=.7, xlim = c(3,8),
              xlab = "Mean Expression", main = 'Simulated',
              ylab = "Dropout Rate",ylim = c(0,1),
              colramp = pal)
smoothScatter(colMeans(log1p(getMu(simModel_more0))), colMeans(getPi(simModel_more0)),
              nrpoints=Inf, pch="", cex=.7, xlim = c(3,8), nbin = 256,
              xlab = "Mean Expression", main = 'Simulated more 0s',
              ylab = "Dropout Rate",ylim = c(0,1),
              colramp = pal)
```

```{r sim10low}
B = 10
simData = lapply(seq_len(B), function(i) zinbSim(simModel, seed=i))
save(simModel, simData,
     file = "~/Documents/BRAIN/gitrepo/zinb_analysis/sims/datasets/sim_allen_lowZero.rda")
```

```{r sim10high}
B = 10
simData_more0 = lapply(seq_len(B), function(i) zinbSim(simModel_more0, seed=i))
save(simModel_more0, simData_more0,
     file = "~/Documents/BRAIN/gitrepo/zinb_analysis/sims/datasets/sim_allen_highZero.rda")
```

```{r zeroFractionAll}
zeroFrac = data.frame(low = sapply(simData, function(x) x$zeroFraction),
                      high = sapply(simData_more0, function(x) x$zeroFraction),
                      observed = sum(core==0)/(nrow(core) * ncol(core)))
zeroFrac = melt(zeroFrac)
zeroFrac$variable = factor(zeroFrac$variable,
                           levels = c('observed', 'low', 'high'))
ggplot(zeroFrac, aes(x = variable, y = value)) + geom_boxplot() + 
  ylab('zero fraction')
```


