---
title: "Fluidigm data"
author: "Davide Risso"
date: "March 21, 2016"
output: html_document
---

# All data

```{r options, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(fig.align="center", cache=TRUE, error=FALSE, message=FALSE, echo=FALSE, warning=FALSE, results="hide", fig.width=10, fig.height=10, eval=TRUE)

library(scRNAseq)
library(scone)
library(scde)
library(genefilter)

library(RColorBrewer)
cols <- c(brewer.pal(9, "Set1"), brewer.pal(8, "Set2"), brewer.pal(9, "Set3"))
```


```{r datain}
data(fluidigm)

bio <- as.factor(fluidigm$Biological_Condition)
coverage <- as.factor(fluidigm$Coverage_Type)
clusters <- as.factor(fluidigm$Cluster2)
```

```{r filtering, dependson="datain"}
filter <- apply(assay(fluidigm), 1, function(x) length(x[x >= 5]) >= 5)
filter2 <- apply(assay(fluidigm, 2), 1, function(x) length(x[x >= 5]) >= 5)

fluidigm <- fluidigm[filter & filter2,]
```

## Regular PCA

```{r pca, dependson="filtering"}
pc <- prcomp(t(log1p(assay(fluidigm))), center=TRUE, scale=TRUE)

pc_fpkm <- prcomp(t(log1p(assay(fluidigm, 2))), center=TRUE, scale=TRUE)

deseq <- DESEQ_FN(assay(fluidigm))
pc_deseq <- prcomp(t(log1p(deseq)), center=TRUE, scale=TRUE)

```

```{r pca_plot_raw, dependson="pca"}
plot(pc$x[,1:2], col=cols[bio], pch=c(16, 17)[coverage], main="Unnormalized counts")

plot(pc_deseq$x[,1:2], col=cols[clusters], pch=c(16, 17)[coverage], main="DESeq normalization, by cluster")
legend("topleft", levels(clusters), fill=cols)

plot(pc_deseq$x[,1:2], col=cols[bio], pch=c(16, 17)[coverage], main="DESeq normalization, by condition")
legend("topleft", levels(bio), fill=cols)

plot(pc_fpkm$x[,1:2], col=cols[clusters], pch=c(16, 17)[coverage], main="FPKM, by cluster")
legend("bottomleft", levels(clusters), fill=cols)

plot(pc_fpkm$x[,1:2], col=cols[bio], pch=c(16, 17)[coverage], main="FPKM, by condition")
legend("bottomleft", levels(bio), fill=cols)

plot(pc$x[,1]~colSums(deseq>0), col=cols[clusters], pch=c(16, 17)[coverage], main="Raw counts, correlation bw PC1 and detection rate", xlab="Detection rate", ylab="PC1")

plot(pc_deseq$x[,1]~colSums(deseq>0), col=cols[clusters], pch=c(16, 17)[coverage], main="DESeq, correlation bw PC1 and detection rate", xlab="Detection rate", ylab="PC1")

plot(pc_fpkm$x[,1]~colSums(deseq>0), col=cols[clusters], pch=c(16, 17)[coverage], main="FPKM, correlation bw PC1 and detection rate", xlab="Detection rate", ylab="PC1")
```

## Weighted PCA (scone and scde)

```{r wpca, dependson="datain"}
w <- estimate_zinb(round(deseq))
wpc <- bwpca(t(log1p(deseq)), t(w$p_z), npcs = 3)
```

```{r wpca_plot, dependson="wpca"}
plot(wpc$scores[,1:2], col=cols[clusters], pch=c(16, 17)[coverage], main="Weighted PCA (scone), by cluster")
legend("topleft", levels(clusters), fill=cols)

plot(wpc$scores[,1:2], col=cols[bio], pch=c(16, 17)[coverage], main="Weighted PCA (scone), by condition")
legend("topleft", levels(bio), fill=cols)

plot(wpc$scores[,1]~colSums(deseq>0), col=cols[clusters], pch=c(16, 17)[coverage], main="wPCA (scone), correlation bw wPC1 and detection rate", xlab="Detection rate", ylab="PC1")
```

```{r scde, dependson="datain"}
o.ifm <- scde.error.models(counts = round(deseq), groups = bio, n.cores = 4, threshold.segmentation = TRUE, save.crossfit.plots = FALSE, save.model.plots = FALSE, verbose = 0)

p.self.fail <- scde.failure.probability(models = o.ifm, counts = round(deseq))

o.prior <- scde.expression.prior(models = o.ifm, counts = round(deseq), length.out = 400, show.plot = FALSE)
jp <- scde.posteriors(models = o.ifm, round(deseq), o.prior, return.individual.posterior.modes = TRUE, n.cores = 4)
jp$jp.modes <- log(as.numeric(colnames(jp$jp)))[max.col(jp$jp)]
p.mode.fail <- scde.failure.probability(models = o.ifm, magnitudes = jp$jp.modes)
matw <- 1-sqrt(p.self.fail*sqrt(p.self.fail*p.mode.fail))

wpc2 <- bwpca(t(log1p(deseq)), t(matw), npcs = 3)
```

```{r scde_plot, dependson="scde"}
plot(wpc2$scores[,1:2], col=cols[clusters], pch=c(16, 17)[coverage], main="Weighted PCA (scde), by cluster")
legend("topleft", levels(clusters), fill=cols)

plot(wpc2$scores[,1:2], col=cols[bio], pch=c(16, 17)[coverage], main="Weighted PCA (scde), by condition")
legend("topleft", levels(bio), fill=cols)

plot(wpc2$scores[,1]~colSums(deseq>0), col=cols[clusters], pch=c(16, 17)[coverage], main="wPCA (scde), correlation bw wPC1 and detection rate", xlab="Detection rate", ylab="PC1")
```

## Imputed data

```{r impuation, dependson="wpca"}
imputed <- round(deseq) * (w$p_z) + w$mu * (1 - w$p_z)
pc_imputed <- prcomp(t(log1p(imputed)), center=TRUE, scale=TRUE)

imputed2 <- round(deseq) * matw + w$mu * (1 - matw)
pc_imputed2 <- prcomp(t(log1p(imputed2)), center=TRUE, scale=TRUE)
```

```{r imputed_plot, dependson="imputation"}
plot(pc_imputed$x[,1:2], col=cols[clusters], pch=c(16, 17)[coverage], main="Imputed data (scone), by cluster")
legend("topleft", levels(clusters), fill=cols)

plot(pc_imputed$x[,1:2], col=cols[bio], pch=c(16, 17)[coverage], main="Imputed data (scone), by condition")
legend("topleft", levels(bio), fill=cols)

plot(pc_imputed$x[,1]~colSums(deseq>0), col=cols[clusters], pch=c(16, 17)[coverage], main="Imputed counts (scone), correlation bw PC1 and detection rate", xlab="Detection rate", ylab="PC1")

plot(pc_imputed2$x[,1:2], col=cols[clusters], pch=c(16, 17)[coverage], main="Imputed data (scde), by cluster")
legend("bottomleft", levels(clusters), fill=cols)

plot(pc_imputed2$x[,1:2], col=cols[bio], pch=c(16, 17)[coverage], main="Imputed data (scde), by condition")
legend("bottomleft", levels(bio), fill=cols)

plot(pc_imputed2$x[,1]~colSums(deseq>0), col=cols[clusters], pch=c(16, 17)[coverage], main="Imputed counts (scde), correlation bw PC1 and detection rate", xlab="Detection rate", ylab="PC1")
```

There is clearly something wrong with this. I am not sure whether it's because the weights are not correct or if it's because the average is not correct (I suspect the latter, given that we are estimating a fixed mean in a heterogeneous population).

## Correlation with sample quality

```{r qc, depedson="datain"}
qc <- as.matrix(colData(fluidigm)[,metadata(fluidigm)$which_qc])
qc_pca <- prcomp(qc, center=TRUE, scale=TRUE)

plot(qc_pca$x[,1:2], col=cols[bio], pch=c(16, 17)[coverage], main="Sample quality, by condition")
legend("bottomleft", levels(bio), fill=cols)

plot(qc_pca$x[,1:2], col=cols[clusters], pch=c(16, 17)[coverage], main="Sample quality, by cluster")
legend("bottomleft", levels(clusters), fill=cols)

library(clusterCells)
col_qual <- colorRampPalette(seqPal5)(ncol(deseq))[rank(qc_pca$x[,1])]
plot(pc_deseq$x[,1:2], col=col_qual, pch=c(16, 17)[coverage], main="DESeq normalization, by sample quality")
plot(pc_fpkm$x[,1:2], col=col_qual, pch=c(16, 17)[coverage], main="FPKM, by sample quality")
plot(wpc$scores[,1:2], col=col_qual, pch=c(16, 17)[coverage], main="wPCA (scone), by sample quality")
plot(wpc2$scores[,1:2], col=col_qual, pch=c(16, 17)[coverage], main="wPCA (scde), by sample quality")

boxplot(qc_pca$x[,1]~bio, ylab="QC PC1", main="Sample quality by condition")
boxplot(qc_pca$x[,1]~clusters, ylab="QC PC1", main="Sample quality by cluster")
```

```{r qc_plots, dependson="qc"}
par(mfrow=c(3, 3))
for(i in 2:ncol(qc))
boxplot(qc[,i]~clusters, main=colnames(qc)[i])

for(i in 2:ncol(qc))
boxplot(qc[,i]~bio, main=colnames(qc)[i], las=2)
```

## Marker genes

In the original pubblication, they provide a heatmap of the top genes, based on the highest loadings with PC1--3. We should do the same with wPCA and see whether we get better results.

```{r heatmap, dependson=c("pca", "wpca", "scde")}
library(clusterCells)
genes_fpkm <- unique(unlist(lapply(1:3, function(i) names(sort(abs(pc_fpkm$rotation[,i]), decreasing = TRUE))[1:100])))
dualHeatmap(heatData=t(assay(fluidigm, 2)), dual=FALSE, whVars = genes_fpkm, annCol = data.frame(Condition=bio, Cluster=clusters), main="fpkm")

genes_deseq <- unique(unlist(lapply(1:3, function(i) names(sort(abs(pc_deseq$rotation[,i]), decreasing = TRUE))[1:100])))
dualHeatmap(heatData=t(deseq), dual=FALSE, whVars = genes_deseq, annCol = data.frame(Condition=bio, Cluster=clusters), main="deseq")

genes_scone <- unique(unlist(lapply(1:3, function(i) names(sort(abs(wpc$rotation[,i]), decreasing = TRUE))[1:100])))
dualHeatmap(heatData=t(deseq), dual=FALSE, whVars = genes_scone, annCol = data.frame(Condition=bio, Cluster=clusters), main="scone")

genes_scde <- unique(unlist(lapply(1:3, function(i) names(sort(abs(wpc2$rotation[,i]), decreasing = TRUE))[1:100])))
dualHeatmap(heatData=t(deseq), dual=FALSE, whVars = genes_scde, annCol = data.frame(Condition=bio, Cluster=clusters), main="scde")
```

# High coverage

Here, we will repeat the analysis for high-coverage only and low-coverage only data.

```{r}
low <- fluidigm[fluidigm$Coverage_Type=="Low"]
high <- fluidigm[fluidigm$Coverage_Type=="High"]
```

